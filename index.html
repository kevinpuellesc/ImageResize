<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Optimizador Pro: Edici√≥n y SEO</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .card { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .temp-slider { background: linear-gradient(to right, #3b82f6, #f3f4f6, #f97316) !important; height: 8px; border-radius: 4px; appearance: none; width: 100%; }
        .temp-slider::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; background: white; border: 2px solid #4b5563; border-radius: 50%; cursor: pointer; }
        .center-mark { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 2px; height: 12px; background: #9ca3af; pointer-events: none; z-index: 1; }
        
        #previewContainer img { max-width: 100%; height: auto; border-radius: 12px; background: repeating-conic-gradient(#fff 0% 25%, #f3f4f6 0% 50%) 50% / 20px 20px; }
        
        .progress-bar-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-fill { background-color: #10b981; height: 100%; width: 0%; transition: width 0.3s ease; }

        .btn-download-single { background-color: #10b981; color: white; padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: bold; }
        .badge-srgb { background-color: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-weight: 700; font-size: 8px; }
    </style>
</head>
<body class="p-2 sm:p-4 min-h-screen flex items-center justify-center">

    <div id="app" class="w-full max-w-6xl bg-white rounded-2xl card overflow-hidden flex flex-col lg:flex-row">
        
        <div class="w-full lg:w-1/3 p-5 sm:p-6 border-b lg:border-b-0 lg:border-r border-gray-100 overflow-y-auto max-h-[90vh]">
            <header class="mb-4 text-xl font-bold text-gray-800">üì∏ Portafolio Studio</header>

            <div class="space-y-4">
                <div class="relative group">
                    <input type="file" id="imageInput" accept="image/*" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleImageSelection(event)">
                    <div class="p-4 border-2 border-dashed border-gray-300 rounded-xl text-center bg-gray-50">
                        <p class="text-xs font-semibold text-gray-600" id="fileInstruction">Subir im√°genes</p>
                    </div>
                </div>

                <div id="controls" class="hidden space-y-4">
                    <div class="space-y-3 bg-gray-50 p-4 rounded-xl border">
                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Luz y Color</h3>
                        <div><input type="range" id="brightnessSlider" min="50" max="150" value="100" class="w-full accent-emerald-500" onchange="updateUI()"></div>
                        <div><input type="range" id="contrastSlider" min="50" max="150" value="100" class="w-full accent-emerald-500" onchange="updateUI()"></div>
                        <div><input type="range" id="saturationSlider" min="0" max="200" value="100" class="w-full accent-emerald-500" onchange="updateUI()"></div>
                    </div>

                    <div class="space-y-3 bg-gray-50 p-4 rounded-xl border">
                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Definici√≥n y Tono</h3>
                        <div>
                            <div class="flex justify-between text-[10px]"><span>Enfoque</span><span id="sharpVal">0</span></div>
                            <input type="range" id="sharpSlider" min="0" max="1" step="0.1" value="0" class="w-full accent-blue-500" onchange="updateUI()">
                        </div>
                        <div class="relative pt-1">
                            <input type="range" id="tempSlider" min="-100" max="100" value="0" class="temp-slider" onchange="updateUI()">
                        </div>
                    </div>

                    <div class="space-y-3 bg-white p-4 rounded-xl border border-emerald-100">
                        <div class="flex justify-between items-center"><h3 class="text-[10px] font-bold text-emerald-600 uppercase">SEO y Exportaci√≥n</h3><span class="badge-srgb">sRGB ACTIVO</span></div>
                        <input type="text" id="filenameTemplate" value="portfolio-{{num}}" class="w-full p-2 border rounded text-xs">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="outputFormat" class="p-2 bg-white border rounded text-xs">
                                <option value="image/webp">WebP</option>
                                <option value="image/jpeg">JPEG</option>
                            </select>
                            <input type="number" id="maxDimensionInput" value="1200" class="p-2 border rounded text-xs">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1"><span>Calidad</span><span id="qualityVal">85%</span></div>
                            <input type="range" id="qualitySlider" min="10" max="100" value="85" class="w-full accent-emerald-600" oninput="updateUI()">
                        </div>
                    </div>

                    <div id="progressSection" class="hidden space-y-2">
                        <div class="progress-bar-container"><div id="progressBarFill" class="progress-bar-fill"></div></div>
                        <p id="progressText" class="text-[10px] text-center font-bold text-gray-400"></p>
                    </div>

                    <button id="processButton" onclick="processAllImages()" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-xl active:scale-95 transition-all">
                        Procesar <span id="imageCount">0</span> Fotos
                    </button>
                </div>
            </div>
        </div>

        <div id="previewArea" class="hidden w-full lg:w-2/3 bg-gray-100 p-4 sm:p-8 flex flex-col items-center justify-center">
            <div id="previewContainer" class="w-full flex justify-center"></div>
            <div id="results" class="hidden w-full max-w-md bg-white p-4 rounded-xl shadow-sm border mt-6">
                <button onclick="downloadAllAsZip()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mb-4">Descargar Lote (.zip)</button>
                <div id="resultsList" class="space-y-1 max-h-64 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <canvas id="imageCanvas" class="hidden"></canvas>

    <script>
        let selectedFiles = [];
        let processedImagesData = [];
        let currentPreviewImage = null;
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d', { colorSpace: 'srgb' });

        function handleImageSelection(event) {
            selectedFiles = Array.from(event.target.files).filter(f => f.type.startsWith('image/'));
            if (selectedFiles.length === 0) return;
            document.getElementById('imageCount').textContent = selectedFiles.length;
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('previewArea').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentPreviewImage = new Image();
                currentPreviewImage.onload = () => updateUI();
                currentPreviewImage.src = e.target.result;
            };
            reader.readAsDataURL(selectedFiles[0]);
        }

        function updateUI() {
            document.getElementById('sharpVal').innerText = document.getElementById('sharpSlider').value;
            document.getElementById('qualityVal').innerText = document.getElementById('qualitySlider').value + '%';
            generatePreview();
        }

        async function generatePreview() {
            if (!currentPreviewImage) return;
            const settings = getSettings();
            settings.maxDimension = 600; // Preview ultra r√°pida
            const res = await applyFilters(currentPreviewImage, settings);
            document.getElementById('previewContainer').innerHTML = `<img src="${URL.createObjectURL(res.blob)}">`;
        }

        function getSettings() {
            return {
                brightness: document.getElementById('brightnessSlider').value,
                contrast: document.getElementById('contrastSlider').value,
                saturation: document.getElementById('saturationSlider').value,
                temperature: parseInt(document.getElementById('tempSlider').value),
                sharpness: parseFloat(document.getElementById('sharpSlider').value),
                quality: parseFloat(document.getElementById('qualitySlider').value) / 100,
                maxDimension: parseInt(document.getElementById('maxDimensionInput').value) || 1200,
                mime: document.getElementById('outputFormat').value,
                template: document.getElementById('filenameTemplate').value || 'img-{{num}}'
            };
        }

        function applyFilters(img, s) {
            return new Promise((resolve) => {
                let { width, height } = img;
                const ratio = Math.min(s.maxDimension / width, s.maxDimension / height, 1);
                width = Math.floor(width * ratio);
                height = Math.floor(height * ratio);
                
                canvas.width = width;
                canvas.height = height;

                // Aplicar filtros b√°sicos
                ctx.filter = `brightness(${s.brightness}%) contrast(${s.contrast}%) saturate(${s.saturation}%)`;
                ctx.drawImage(img, 0, 0, width, height);

                // Temperatura
                if (s.temperature !== 0) {
                    ctx.globalCompositeOperation = 'soft-light';
                    const alpha = Math.abs(s.temperature) / 250;
                    ctx.fillStyle = s.temperature > 0 ? `rgba(255, 150, 0, ${alpha})` : `rgba(0, 100, 255, ${alpha})`;
                    ctx.fillRect(0, 0, width, height);
                    ctx.globalCompositeOperation = 'source-over';
                }

                // Sharpen (Solo si es necesario, es lo m√°s lento)
                if (s.sharpness > 0) {
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const output = new Uint8ClampedArray(imageData.data.length);
                    const input = imageData.data;
                    const amount = s.sharpness;
                    for (let y = 1; y < height - 1; y++) {
                        for (let x = 1; x < width - 1; x++) {
                            for (let c = 0; c < 3; c++) {
                                const i = (y * width + x) * 4 + c;
                                output[i] = input[i] * (1 + 4 * amount) - (input[i - 4] + input[i + 4] + input[i - width * 4] + input[i + width * 4]) * amount;
                            }
                            output[(y * width + x) * 4 + 3] = input[(y * width + x) * 4 + 3];
                        }
                    }
                    ctx.putImageData(new ImageData(output, width, height), 0, 0);
                }

                canvas.toBlob(blob => resolve({blob}), s.mime, s.quality);
            });
        }

        async function processAllImages() {
            const total = selectedFiles.length;
            const settings = getSettings();
            document.getElementById('progressSection').classList.remove('hidden');
            processedImagesData = [];
            document.getElementById('resultsList').innerHTML = '';

            for (let i = 0; i < total; i++) {
                // Actualizar barra antes de empezar cada foto
                const percent = Math.round((i / total) * 100);
                document.getElementById('progressBarFill').style.width = percent + '%';
                document.getElementById('progressText').innerText = `Procesando ${i + 1} de ${total}...`;

                // Peque√±a pausa para dejar que el navegador respire y actualice la UI
                await new Promise(r => setTimeout(r, 50));

                const img = await loadImage(selectedFiles[i]);
                const res = await applyFilters(img, settings);
                
                const finalName = settings.template.replace('{{num}}', String(i + 1).padStart(3, '0'));
                const ext = settings.mime === 'image/webp' ? '.webp' : '.jpg';
                
                processedImagesData.push({ blob: res.blob, finalName, ext });
                
                document.getElementById('resultsList').insertAdjacentHTML('beforeend', `
                    <div class="text-[10px] p-2 border-b flex justify-between bg-white">
                        <span>${finalName}${ext}</span>
                        <span class="text-emerald-500 font-bold">‚úì Listo</span>
                    </div>`);
            }
            
            document.getElementById('progressBarFill').style.width = '100%';
            document.getElementById('progressText').innerText = "¬°Completado!";
            document.getElementById('results').classList.remove('hidden');
        }

        function loadImage(file) {
            return new Promise(res => {
                const r = new FileReader();
                r.onload = e => { const i = new Image(); i.onload = () => res(i); i.src = e.target.result; };
                r.readAsDataURL(file);
            });
        }

        async function downloadAllAsZip() {
            const zip = new JSZip();
            processedImagesData.forEach(d => zip.file(`${d.finalName}${d.ext}`, d.blob));
            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = "lote_sRGB.zip";
            a.click();
        }
    </script>
</body>
</html>
