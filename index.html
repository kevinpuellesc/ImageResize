<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Optimizador Pro: Edici贸n y Lote</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; -webkit-tap-highlight-color: transparent; }
        .card { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .temp-slider { background: linear-gradient(to right, #3b82f6, #f3f4f6, #f97316) !important; height: 8px; border-radius: 4px; appearance: none; width: 100%; }
        .temp-slider::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; background: white; border: 2px solid #4b5563; border-radius: 50%; cursor: pointer; }
        .center-mark { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 2px; height: 12px; background: #9ca3af; pointer-events: none; z-index: 1; }
        
        #previewContainer { position: relative; width: 100%; display: flex; justify-content: center; }
        #previewContainer img { max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); background: #eee; }
        
        /* Bot贸n de comparaci贸n */
        .compare-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 8px 12px; border-radius: 8px; font-size: 10px; font-weight: bold; backdrop-filter: blur(4px); cursor: pointer; user-select: none; transition: all 0.2s; }
        .compare-btn:active { background: rgba(0,0,0,0.9); transform: scale(0.95); }

        .progress-bar-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar-fill { background-color: #10b981; height: 100%; width: 0%; transition: width 0.2s; }
    </style>
</head>
<body class="p-2 sm:p-4 min-h-screen flex items-center justify-center">

    <div id="app" class="w-full max-w-6xl bg-white rounded-2xl card overflow-hidden flex flex-col lg:flex-row">
        
        <div class="w-full lg:w-1/3 p-5 sm:p-6 border-b lg:border-b-0 lg:border-r border-gray-100 overflow-y-auto max-h-screen custom-scroll">
            <header class="mb-4">
                <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2"><span></span> Portafolio Editor</h1>
            </header>

            <div class="space-y-4">
                <div class="relative group">
                    <input type="file" id="imageInput" accept="image/*" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleImageSelection(event)">
                    <div class="p-4 border-2 border-dashed border-gray-300 rounded-xl text-center group-hover:border-emerald-500 transition-all">
                        <p class="text-xs font-semibold text-gray-600">Subir im谩genes</p>
                    </div>
                </div>

                <div id="controls" class="hidden space-y-4">
                    <div class="space-y-3 bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Ajustes de Luz y Color</h3>
                        
                        <div>
                            <div class="flex justify-between text-[10px] mb-1"><span>Brillo</span><span id="brightnessVal">100%</span></div>
                            <input type="range" id="brightnessSlider" min="50" max="150" value="100" class="w-full accent-emerald-500" oninput="updateUI()">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1"><span>Contraste</span><span id="contrastVal">100%</span></div>
                            <input type="range" id="contrastSlider" min="50" max="150" value="100" class="w-full accent-emerald-500" oninput="updateUI()">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1"><span>Saturaci贸n</span><span id="saturationVal">100%</span></div>
                            <input type="range" id="saturationSlider" min="0" max="200" value="100" class="w-full accent-emerald-500" oninput="updateUI()">
                        </div>
                        <div class="relative pt-2">
                            <div class="flex justify-between text-[10px] mb-1"><span>Temperatura</span><span id="tempValue">0</span></div>
                            <div class="relative flex items-center h-6">
                                <div class="center-mark"></div>
                                <input type="range" id="tempSlider" min="-100" max="100" value="0" class="temp-slider relative z-10" oninput="updateUI()">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3 bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Detalle y Exportaci贸n</h3>
                        
                        <div>
                            <div class="flex justify-between text-[10px] mb-1"><span>Enfoque (Sharpen)</span><span id="sharpVal">0</span></div>
                            <input type="range" id="sharpSlider" min="0" max="1" step="0.1" value="0" class="w-full accent-blue-500" oninput="updateUI()">
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <select id="outputFormat" class="p-2 bg-white border border-gray-200 rounded-lg text-xs" onchange="updateUI()">
                                <option value="image/webp">WebP</option>
                                <option value="image/jpeg">JPG</option>
                            </select>
                            <input type="number" id="maxDimensionInput" value="1080" class="p-2 border border-gray-200 rounded-lg text-xs">
                        </div>
                    </div>

                    <div id="progressSection" class="hidden space-y-2">
                        <div class="progress-bar-container"><div id="progressBarFill" class="progress-bar-fill"></div></div>
                        <p id="progressText" class="text-[10px] text-center font-bold text-gray-500 uppercase"></p>
                    </div>

                    <button id="processButton" onclick="processAllImages()" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all">
                        Procesar <span id="imageCount">0</span> Fotos
                    </button>
                </div>
            </div>
        </div>

        <div id="previewArea" class="hidden w-full lg:w-2/3 bg-gray-100 p-4 sm:p-8 flex flex-col justify-center items-center">
            <div id="previewContainer">
                <div class="compare-btn" onmousedown="showOriginal()" onmouseup="showProcessed()" ontouchstart="showOriginal()" ontouchend="showProcessed()">MANTENER PARA COMPARAR</div>
            </div>

            <div id="results" class="hidden w-full max-w-md mt-6">
                <button onclick="downloadAllAsZip()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mb-4">Descargar Todo (.ZIP)</button>
                <div id="resultsList" class="space-y-1 max-h-32 overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>

    <canvas id="imageCanvas" class="hidden"></canvas>

    <script>
        let selectedFiles = [];
        let processedImagesData = [];
        let currentPreviewImage = null;
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');

        function handleImageSelection(event) {
            const files = Array.from(event.target.files).filter(f => f.type.startsWith('image/'));
            if (files.length === 0) return;
            selectedFiles = files;
            document.getElementById('imageCount').textContent = files.length;
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('previewArea').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentPreviewImage = new Image();
                currentPreviewImage.onload = () => updateUI();
                currentPreviewImage.src = e.target.result;
            };
            reader.readAsDataURL(files[0]);
        }

        function updateUI() {
            document.getElementById('brightnessVal').innerText = document.getElementById('brightnessSlider').value + '%';
            document.getElementById('contrastVal').innerText = document.getElementById('contrastSlider').value + '%';
            document.getElementById('saturationVal').innerText = document.getElementById('saturationSlider').value + '%';
            document.getElementById('tempValue').innerText = document.getElementById('tempSlider').value;
            document.getElementById('sharpVal').innerText = document.getElementById('sharpSlider').value;
            generatePreview();
        }

        async function generatePreview() {
            if (!currentPreviewImage) return;
            const settings = getSettings();
            settings.maxDimension = 800; // Preview r谩pido
            const res = await applyFilters(currentPreviewImage, settings);
            const imgHtml = `<img id="mainPreview" src="${URL.createObjectURL(res.blob)}">
                             <div class="compare-btn" onmousedown="showOriginal()" onmouseup="showProcessed()" ontouchstart="showOriginal()" ontouchend="showProcessed()">COMPARAR</div>`;
            document.getElementById('previewContainer').innerHTML = imgHtml;
        }

        function getSettings() {
            return {
                brightness: document.getElementById('brightnessSlider').value,
                contrast: document.getElementById('contrastSlider').value,
                saturation: document.getElementById('saturationSlider').value,
                temperature: parseInt(document.getElementById('tempSlider').value),
                sharpness: parseFloat(document.getElementById('sharpSlider').value),
                quality: 0.85,
                maxDimension: parseInt(document.getElementById('maxDimensionInput').value) || 1080,
                mime: document.getElementById('outputFormat').value
            };
        }

        function showOriginal() {
            if(currentPreviewImage) document.getElementById('mainPreview').src = currentPreviewImage.src;
        }

        async function showProcessed() {
            await generatePreview();
        }

        function applyFilters(img, s) {
            return new Promise((resolve) => {
                let { width, height } = img;
                const ratio = Math.min(s.maxDimension / width, s.maxDimension / height, 1);
                width *= ratio; height *= ratio;
                canvas.width = width; canvas.height = height;

                // Aplicar filtros b谩sicos (Brillo, Contraste, Saturaci贸n)
                ctx.filter = `brightness(${s.brightness}%) contrast(${s.contrast}%) saturate(${s.saturation}%)`;
                ctx.drawImage(img, 0, 0, width, height);

                // Aplicar Temperatura
                if (s.temperature !== 0) {
                    ctx.filter = 'none';
                    ctx.globalCompositeOperation = 'soft-light';
                    const alpha = Math.abs(s.temperature) / 250;
                    ctx.fillStyle = s.temperature > 0 ? `rgba(255, 150, 0, ${alpha})` : `rgba(0, 100, 255, ${alpha})`;
                    ctx.fillRect(0, 0, width, height);
                    ctx.globalCompositeOperation = 'source-over';
                }

                // Aplicar Enfoque (Sharpen) mediante convoluci贸n simple si es > 0
                if (s.sharpness > 0) {
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const sharpened = sharpen(imageData, s.sharpness);
                    ctx.putImageData(sharpened, 0, 0);
                }

                canvas.toBlob(blob => resolve({blob}), s.mime, s.quality);
            });
        }

        // Algoritmo de Sharpen (Laplacian)
        function sharpen(data, amount) {
            const width = data.width;
            const height = data.height;
            const input = data.data;
            const output = new Uint8ClampedArray(input.length);
            const mix = amount;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        const i = (y * width + x) * 4 + c;
                        const val = input[i] * (1 + 4 * mix) - (
                            input[i - 4] + input[i + 4] + 
                            input[i - width * 4] + input[i + width * 4]
                        ) * mix;
                        output[i] = val;
                    }
                    output[(y * width + x) * 4 + 3] = input[(y * width + x) * 4 + 3];
                }
            }
            return new ImageData(output, width, height);
        }

        async function processAllImages() {
            const total = selectedFiles.length;
            const settings = getSettings();
            settings.ext = settings.mime === 'image/jpeg' ? '.jpg' : '.webp';
            
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('resultsList').innerHTML = '';
            processedImagesData = [];

            for (let i = 0; i < total; i++) {
                const percent = Math.round(((i + 1) / total) * 100);
                document.getElementById('progressBarFill').style.width = percent + '%';
                document.getElementById('progressText').innerText = `Procesando ${i+1} de ${total}`;

                const img = await loadImage(selectedFiles[i]);
                const res = await applyFilters(img, settings);
                processedImagesData.push({blob: res.blob, fileName: selectedFiles[i].name, ext: settings.ext});
                
                const item = `<div class="text-[10px] p-2 bg-white border mb-1 rounded flex justify-between"><span>${selectedFiles[i].name}</span><span class="text-emerald-500">OK</span></div>`;
                document.getElementById('resultsList').insertAdjacentHTML('beforeend', item);
                await new Promise(r => setTimeout(r, 20));
            }
            document.getElementById('results').classList.remove('hidden');
        }

        function loadImage(file) {
            return new Promise(res => {
                const r = new FileReader();
                r.onload = e => { const i = new Image(); i.onload = () => res(i); i.src = e.target.result; };
                r.readAsDataURL(file);
            });
        }

        async function downloadAllAsZip() {
            const zip = new JSZip();
            processedImagesData.forEach((d, i) => {
                zip.file(`opt-${String(i+1).padStart(3, '0')}${d.ext}`, d.blob);
            });
            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = "lote_optimizado.zip";
            a.click();
        }
    </script>
</body>
</html>
